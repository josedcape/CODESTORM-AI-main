{% extends "base.html" %}

{% block title %}Agente de Desarrollo - Codestorm Assistant{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tech-selector.css') }}">
<style>
    .card-futuristic {
        background-color: #222;
        color: #eee;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }

    .card-header-futuristic {
        background-color: #333;
        color: #fff;
        border-bottom: 1px solid #444;
        padding: 1rem;
    }

    .futuristic-input {
        background-color: #333;
        color: #eee;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 0.5rem;
    }

    .futuristic-select {
        background-color: #333;
        color: #eee;
        border: 1px solid #555;
        border-radius: 5px;
    }

    .btn-futuristic {
        background-color: #1E88E5;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 0.8rem 1.5rem;
        transition: all 0.3s ease;
    }

    .btn-futuristic:hover {
        background-color: #2196F3;
        box-shadow: 0 5px 15px rgba(30, 136, 229, 0.3);
    }

    .btn-outline-primary.btn-futuristic {
        background-color: transparent;
        border: 2px solid #1E88E5;
        color: #1E88E5;
    }

    .btn-outline-primary.btn-futuristic:hover {
        background-color: #1E88E5;
        color: white;
    }

    .btn-outline-secondary.btn-futuristic {
        background-color: transparent;
        border: 2px solid #6c757d;
        color: #6c757d;
    }

    .btn-outline-secondary.btn-futuristic:hover {
        background-color: #6c757d;
        color: white;
    }

    .feature-tag {
        display: inline-block;
        background-color: #1E88E5;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        margin: 0.2rem;
        font-size: 0.85rem;
    }

    .feature-tag .remove-tag {
        cursor: pointer;
        margin-left: 5px;
    }

    .console-output {
        background-color: #121212;
        color: #00FF00;
        font-family: monospace;
        padding: 10px;
        border-radius: 5px;
        height: 150px;
        overflow-y: auto;
        margin-top: 15px;
    }

    /* Estilos para las tarjetas de tecnologías */
    .tech-stack-card {
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .tech-stack-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .tech-stack-card .card-header {
        background: linear-gradient(90deg, #091428 0%, #0A2149 100%);
        color: white;
        border-bottom: none;
    }

    .tech-item {
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .tech-label {
        font-weight: bold;
        min-width: 100px;
    }

    .tech-value {
        font-size: 0.9rem;
        padding: 5px 10px;
        border-radius: 20px;
    }

    .badge.bg-primary {
        background: linear-gradient(135deg, #007bff, #0056b3) !important;
    }


    /* Controles de construcción */
    .constructor-controls {
        margin-top: 30px;
        margin-bottom: 40px;
    }
    .constructor-controls .d-flex {
        justify-content: space-between;
        align-items: center;
    }
    .constructor-controls .controls-left {
        margin-right: 20px;
    }
    .constructor-controls .controls-right {
        margin-left: 20px;
    }
    .constructor-controls .btn {
        margin-right: 5px;
    }
    .constructor-controls .btn.ms-2 {
        margin-left: 10px;
    }

    .badge.bg-success {
        background: linear-gradient(135deg, #28a745, #1e7e34) !important;
    }

    .badge.bg-warning {
        background: linear-gradient(135deg, #ffc107, #d39e00) !important;
    }

    /* Estilos para el Asistente de Chat */
    .chat-float-button {
        position: fixed;
        bottom: 30px;
        left: 30px; /* Cambiado de right a left para posicionarlo a la izquierda */
        z-index: 9999;
    }

    .chat-float-button button {
        width: 60px;
        height: 60px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }

    .chat-float-button button:hover {
        transform: scale(1.05);
    }

    .chat-float-button button i {
        font-size: 24px;
    }

    .chat-panel {
        position: fixed;
        bottom: 100px;
        left: 30px; /* Cambiado de right a left para posicionarlo a la izquierda */
        width: 380px;
        height: 500px;
        background-color: #222;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        z-index: 9998;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .chat-header {
        background: linear-gradient(90deg, #091428 0%, #0A2149 100%);
        color: white;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .chat-input {
        padding: 15px;
        background-color: #333;
        border-top: 1px solid #444;
    }

    .message {
        margin-bottom: 15px;
        max-width: 85%;
        word-wrap: break-word;
        position: relative; /* Para posicionar los botones de acción */
    }

    .user-message {
        margin-left: auto;
        background-color: #1E88E5;
        color: white;
        padding: 10px 15px;
        border-radius: 15px 15px 3px 15px;
    }

    .assistant-message {
        margin-right: auto;
        background-color: #424242;
        color: white;
        padding: 10px 15px;
        border-radius: 15px 15px 15px 3px;
    }

    .system-message {
        background-color: #1c1c1c;
        border-left: 3px solid #1E88E5;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 5px;
        font-size: 0.9rem;
    }

    .context-badge {
        font-size: 0.7rem;
        padding: 2px 8px;
        background-color: #555;
        border-radius: 10px;
        margin-right: 5px;
        color: #ccc;
    }

    .action-message {
        text-align: center;
        margin: 10px 0;
        font-size: 0.85rem;
        color: #aaa;
    }

    /* Animación para el botón de intervención */
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }

    .intervention-active {
        animation: pulse 2s infinite;
        background-color: #dc3545 !important;
    }

    /* Indicador de escritura */
    .typing-indicator {
        display: flex;
        padding: 6px 10px;
        background-color: #424242;
        border-radius: 15px;
        margin-bottom: 15px;
        width: fit-content;
    }

    .typing-bubble {
        width: 7px;
        height: 7px;
        margin: 0 1px;
        background-color: #999;
        border-radius: 50%;
        opacity: 0.6;
    }

    .typing-bubble:nth-child(1) {
        animation: typing 1s infinite 0s;
    }
    .typing-bubble:nth-child(2) {
        animation: typing 1s infinite 0.33s;
    }
    .typing-bubble:nth-child(3) {
        animation: typing 1s infinite 0.66s;
    }

    @keyframes typing {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0px); }
    }

    .message-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: none;
    }

    .message:hover .message-actions {
        display: block;
    }

    .message-actions-extended {
        display: none;
        margin-top: 10px;
        text-align: right;
    }

    .message:hover .message-actions-extended {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    .apply-code-btn, .explore-files-btn, .contextualize-btn {
        background-color: #1a202c;
        color: #63b3ed;
        border: 1px solid #2a4365;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .apply-code-btn:hover, .explore-files-btn:hover, .contextualize-btn:hover {
        background-color: #2d3748;
        color: #90cdf4;
    }

    .code-selection-modal, .file-selection-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .code-selection-dialog, .file-selection-dialog {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        max-width: 800px;
        width: 100%;
    }

    .code-blocks-list {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

    .code-block-option {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
    }

    .code-language-badge {
        background-color: #f0f0f0;
        padding: 3px 8px;
        border-radius: 4px;
        margin-right: 8px;
    }

    .file-selection-tabs {
        display: flex;
        margin-bottom: 15px;
    }

    .file-tab {
        background-color: #eee;
        padding: 8px 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-right: 10px;
        cursor: pointer;
    }

    .file-tab.active {
        background-color: #ddd;
        font-weight: bold;
    }

    .file-panel {
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 10px;
    }

    .code-preview {
        margin-bottom: 15px;
    }

    .dialog-actions {
        text-align: right;
    }

    .related-files {
        margin-top: 15px;
    }

    .files-list {
        list-style: none;
        padding: 0;
    }

    .file-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }

    .file-icon {
        margin-right: 8px;
    }

    .file-path {
        flex: 1;
    }

    .file-actions {
        display: flex;
        gap: 5px;
    }

    .code-context {
        margin-top: 15px;
    }

    .context-section {
        margin-top: 10px;
    }

    .file-content {
        margin-top: 15px;
    }

    .file-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card card-futuristic">
                <div class="card-header card-header-futuristic">
                    <i class="bi bi-code-slash me-2"></i> Agente de Desarrollo con IA
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i> El Agente de Desarrollo utiliza agentes especializados para generar tu aplicación completa basada en tu descripción y stack tecnológico seleccionado.
                    </div>

                    <!-- Selector de Tecnologías -->
                    <div id="tech-selector-container">
                        <div class="tech-selector-header">
                            <h3>Plan de Desarrollo <i class="bi bi-check2-circle"></i></h3>
                            <p>Selecciona el stack tecnológico que prefieres para tu aplicación</p>
                        </div>

                        <div class="tech-selector-nav">
                            <ul class="nav nav-pills nav-fill" id="techSelectorTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="presets-tab" data-bs-toggle="pill" data-bs-target="#presets-content" type="button" role="tab">
                                        <i class="bi bi-lightning-charge me-1"></i> Plantillas
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="backend-tab" data-bs-toggle="pill" data-bs-target="#backend-content" type="button" role="tab">
                                        <i class="bi bi-server me-1"></i> Backend
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="frontend-tab" data-bs-toggle="pill" data-bs-target="#frontend-content" type="button" role="tab">
                                        <i class="bi bi-layout-wtf me-1"></i> Frontend
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="database-tab" data-bs-toggle="pill" data-bs-target="#database-content" type="button" role="tab">
                                        <i class="bi bi-database me-1"></i> Base de Datos
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="features-tab" data-bs-toggle="pill" data-bs-target="#features-content" type="button" role="tab">
                                        <i class="bi bi-puzzle me-1"></i> Características
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <div class="tab-content tech-selector-tab-content" id="techSelectorContent">
                            <!-- Plantillas Predefinidas -->
                            <div class="tab-pane fade show active" id="presets-content" role="tabpanel">
                                <h5>Plantillas de Stack Tecnológico</h5>
                                <p class="text-muted mb-4">Selecciona una plantilla predefinida o personaliza tu stack manualmente en las otras pestañas</p>

                                <div class="row" id="preset-stacks">
                                    <!-- El contenido se generará dinámicamente -->
                                </div>
                            </div>

                            <!-- Backend -->
                            <div class="tab-pane fade" id="backend-content" role="tabpanel">
                                <h5>Selecciona tu Backend</h5>
                                <p class="text-muted mb-4">El backend es responsable de la lógica de negocio y el procesamiento de datos</p>

                                <div id="backend-options">
                                    <!-- El contenido se generará dinámicamente -->
                                </div>
                            </div>

                            <!-- Frontend -->
                            <div class="tab-pane fade" id="frontend-content" role="tabpanel">
                                <h5>Selecciona tu Frontend</h5>
                                <p class="text-muted mb-4">El frontend es la interfaz que verán tus usuarios</p>

                                <div id="frontend-options">
                                    <!-- El contenido se generará dinámicamente -->
                                </div>
                            </div>

                            <!-- Base de Datos -->
                            <div class="tab-pane fade" id="database-content" role="tabpanel">
                                <h5>Selecciona tu Base de Datos</h5>
                                <p class="text-muted mb-4">La base de datos almacenará la información de tu aplicación</p>

                                <div id="database-options">
                                    <!-- El contenido se generará dinámicamente -->
                                </div>
                            </div>

                            <!-- Características Adicionales -->
                            <div class="tab-pane fade" id="features-content" role="tabpanel">
                                <h5>Características Adicionales</h5>
                                <p class="text-muted mb-4">Selecciona las características que requiere tu proyecto</p>

                                <div class="row" id="features-options">
                                    <!-- El contenido se generará dinámicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de selección -->
                        <div class="stack-summary" id="tech-selection-summary">
                            <!-- El contenido se generará dinámicamente -->
                        </div>

                        <div class="compatibility-notice">
                            <h6><i class="bi bi-info-circle me-1"></i> Consejo de compatibilidad</h6>
                            <p>Algunas combinaciones de tecnologías funcionan mejor juntas. Las plantillas predefinidas ofrecen la mejor compatibilidad garantizada.</p>
                        </div>

                        <div class="tech-selector-footer">
                            <button type="button" id="tech-selection-continue" class="btn btn-lg btn-primary btn-futuristic">
                                <i class="bi bi-arrow-right me-2"></i> Continuar al desarrollo
                            </button>
                        </div>
                    </div>

                    <!-- Formulario de Construcción (inicialmente oculto) -->
                    <div id="constructor-container" style="display: none;">
                        <h4 class="mb-4">Detalles del Proyecto</h4>

                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">Stack Tecnológico Seleccionado</h5>
                                        <div id="selected-tech-summary"></div>
                                        <div id="selected-features" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-primary h-100 d-flex align-items-center">
                                    <div>
                                        <h5 class="alert-heading"><i class="bi bi-lightning-charge"></i> ¡Excelente elección!</h5>
                                        <p class="mb-0">Completa la descripción para generar tu aplicación con estas tecnologías.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <form id="constructor-form" onsubmit="return false;">
                            <input type="hidden" id="project-tech-data" name="tech_data" value="">
                        <div class="mb-4">
                            <label for="project-description" class="form-label">Describe tu aplicación</label>
                            <textarea id="project-description" class="form-control futuristic-input" rows="5" 
                                placeholder="Describe en detalle la aplicación que deseas crear. Por ejemplo: 'Una aplicación para gestionar inventario con login, dashboard y reportes en PDF'"></textarea>
                        </div>

                        <!-- Características detectadas -->
                        <div class="mb-3" id="features-container" style="display: none;">
                            <label class="form-label">Características detectadas:</label>
                            <div id="features-tags" class="mb-2"></div>
                            <div class="form-text">Estas características se han detectado automáticamente. Puedes eliminar las que no desees.</div>
                        </div>

                        <!-- Selección de Agente -->
                        <div class="mb-3">
                            <label class="form-label">Selecciona el Agente Especializado:</label>
                            <select id="agent-selector" class="form-select form-select-sm futuristic-select">
                                <option value="developer" selected>Desarrollador de Código</option>
                                <option value="architect">Arquitecto de Software</option>
                                <option value="advanced">Experto Avanzado</option>
                                <option value="general">Asistente General</option>
                            </select>
                            <div class="form-text">El agente determina el enfoque para la generación de tu aplicación</div>
                        </div>

                        <!-- Selección de Modelo de IA -->
                        <div class="mb-3">
                            <label class="form-label">Selecciona el Modelo de IA:</label>
                            <select id="model-selector" class="form-select form-select-sm futuristic-select">
                                <option value="openai" selected>OpenAI (GPT-4o)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="gemini">Google (Gemini)</option>
                            </select>
                            <div id="api-status" class="mt-2 small text-info">Verificando disponibilidad de modelos...</div>
                            <div class="form-text">Diferentes modelos pueden tener distintas capacidades</div>
                        </div>

                        <!-- Opciones Adicionales -->
                        <div class="mb-4">
                            <label class="form-label">Opciones Adicionales:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-tests" checked>
                                <label class="form-check-label" for="include-tests">Incluir pruebas automatizadas</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-docs" checked>
                                <label class="form-check-label" for="include-docs">Generar documentación</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-deployment" checked>
                                <label class="form-check-label" for="include-deployment">Configuración para despliegue</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-ci-cd">
                                <label class="form-check-label" for="include-ci-cd">Configurar CI/CD</label>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary btn-futuristic" id="generate-btn">
                                <i class="bi bi-stars me-2"></i> Generar Aplicación
                            </button>
                        </div>
                    </form>

                    <!-- Indicador de Progreso (oculto inicialmente) -->
                    <div id="generation-progress" class="mt-4" style="display: none;">
                        <h5>Generando tu aplicación...</h5>
                        <div class="progress" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <p id="progress-text">0% completado</p>
                        <p id="current-stage">Inicializando agentes...</p>
                        <div id="framework-info" class="mt-3 d-none">
                            <div class="card tech-stack-card">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="mb-0">Stack Tecnológico</h5>
                                </div>
                                <div class="card-body">
                                    <h6 id="framework-name" class="card-title">No seleccionado</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="tech-item">
                                                <span class="tech-label">Backend:</span>
                                                <span id="backend-tech" class="tech-value badge bg-primary">-</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="tech-item">
                                                <span class="tech-label">Frontend:</span>
                                                <span id="frontend-tech" class="tech-value badge bg-success">-</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="tech-item">
                                                <span class="tech-label">Base de datos:</span>
                                                <span id="database-tech" class="tech-value badge bg-warning text-dark">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Controles de desarrollo -->
                        <div class="mt-3 mb-3 text-center">
                            <button id="pause-development-btn" class="btn btn-warning btn-sm me-2">
                                <i class="bi bi-pause-fill me-1"></i> Pausar Desarrollo
                            </button>
                            <button id="resume-development-btn" class="btn btn-success btn-sm" style="display: none;">
                                <i class="bi bi-play-fill me-1"></i> Reanudar Desarrollo
                            </button>
                        </div>

                        <div class="console-output" id="generation-console"></div>
                    </div>

                    <!-- Resultado (oculto inicialmente) -->
                    <div id="generation-result" class="mt-4" style="display: none;">
                        <div id="result-message" class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i> ¡Tu aplicación ha sido generada exitosamente!
                        </div>
                        <div class="d-grid gap-2">
                            <button id="view-app-btn" class="btn btn-outline-primary btn-futuristic">
                                <i class="bi bi-eye me-2"></i> Ver Aplicación
                            </button>
                            <button id="download-app-btn" class="btn btn-outline-secondary btn-futuristic">
                                <i class="bi bi-download me-2"></i> Descargar Código
                            </button>
                        </div>
                    </div>
                    <div id="message-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botón Flotante del Asistente (ahora posicionado a la izquierda) -->
<div id="assistant-chat-button" class="chat-float-button">
    <button class="btn btn-primary rounded-circle" id="toggle-assistant-chat">
        <i class="bi bi-chat-dots-fill"></i>
    </button>
</div>

<!-- Panel del Asistente de Chat (ahora posicionado a la izquierda) -->
<div id="assistant-chat-panel" class="chat-panel" style="display: none;">
    <div class="chat-header">
        <h5><i class="bi bi-robot"></i> Asistente de Desarrollo</h5>
        <button id="close-assistant-chat" class="btn-close btn-close-white"></button>
    </div>
    <div class="chat-body" id="assistant-chat-messages">
        <div class="system-message">
            <p><strong>¡Hola! Soy tu asistente de desarrollo interactivo.</strong> Puedo ayudarte a modificar funciones específicas de tu proyecto durante su construcción.</p>
            <div class="mt-3">
                <h6 class="mb-2"><i class="bi bi-diagram-3"></i> Ejemplos de modificaciones que puedo realizar:</h6>
                <ul class="mb-3">
                    <li>Añadir nueva función a un archivo existente: <code>"Agrega una función de validación de email al archivo utils.js"</code></li>
                    <li>Modificar un componente: <code>"Modifica el componente Botón para que tenga un estado de carga"</code></li>
                    <li>Optimizar código: <code>"Refactoriza esta función para usar async/await en lugar de promesas"</code></li>
                    <li>Cambiar estilos: <code>"Actualiza los estilos CSS para que los botones sean más redondeados"</code></li>
                    <li>Depurar problemas: <code>"Ayúdame a encontrar el error en esta función que causa un TypeError"</code></li>
                </ul>
            </div>

            <div class="mt-3">
                <h6 class="mb-2"><i class="bi bi-lightbulb"></i> Cómo interactuar conmigo para mejores resultados:</h6>
                <ol>
                    <li>Describe claramente qué función o parte del código quieres modificar</li>
                    <li>Especifica el archivo donde se encuentra (si lo conoces)</li>
                    <li>Explica el comportamiento actual y el deseado</li>
                    <li>Si es necesario, activa el <span class="badge bg-danger">Modo intervención</span> para que pueda realizar cambios directos enel proyecto</li>
                </ol>
            </div>

            <div class="alert alert-info mt-3">
                <i class="bi bi-info-circle"></i> Cuando activas el <strong>Modo intervención</strong>, puedo realizar cambios directos en los archivos de tu proyecto. Esto es útil cuando necesitas modificaciones precisas en funciones específicas.
            </div>
        </div>
    </div>
    <div class="chat-input">
        <div class="input-group">
            <input type="text" id="message-input" class="form-control futuristic-input" 
                   placeholder="Describe los cambios que necesitas...">
            <button class="btn btn-primary" id="send-button">
                <i class="bi bi-send-fill"></i>fill"></i>
            </button>
        </div>
        <div class="chat-context mt-2">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="intervention-mode" checked>
                <label class="form-check-label small" for="intervention-mode">Modo intervención</label>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/tech-selector.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat/chat.js') }}"></script>
<script src="{{ url_for('static', filename='js/agente.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Referencias a elementos DOM
        const assistantPanel = document.getElementById('assistant-chat-panel');
        const chatButton = document.getElementById('toggle-assistant-chat');
        const closeButton = document.getElementById('close-assistant-chat');
        const chatInput = document.getElementById('assistant-chat-input');
        const sendButton = document.getElementById('send-assistant-message');
        const messagesContainer = document.getElementById('assistant-chat-messages');

        const generateBtn = document.getElementById('generate-btn');
        const constructorForm = document.getElementById('constructor-form');
        const generationProgress = document.getElementById('generation-progress');
        const pauseDevelopmentBtn = document.getElementById('pause-development-btn');
        const resumeDevelopmentBtn = document.getElementById('resume-development-btn');
        const generationConsole = document.getElementById('generation-console');

        let projectId = null;

        // Configurar eventos para abrir/cerrar el panel del asistente
        if (chatButton) {
            chatButton.addEventListener('click', function() {
                if (assistantPanel.style.display === 'none' || !assistantPanel.style.display) {
                    assistantPanel.style.display = 'flex';
                    if (chatInput) chatInput.focus();
                } else {
                    assistantPanel.style.display = 'none';
                }
            });
        }

        if (closeButton) {
            closeButton.addEventListener('click', function() {
                assistantPanel.style.display = 'none';
            });
        }

        // Inicializar el sistema de chat para el asistente de desarrollo
        if (sendButton && chatInput) {
            sendButton.addEventListener('click', sendChatMessage);

            // Enviar con Enter
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
        }

        // Función para enviar mensaje de chat
        function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Agregar mensaje del usuario
            const userMsg = document.createElement('div');
            userMsg.className = 'message user-message';
            userMsg.textContent = message;
            messagesContainer.appendChild(userMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Limpiar input
            chatInput.value = '';

            // Mostrar indicador de escritura
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.id = 'typing-indicator';

            for (let i = 0; i < 3; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'typing-bubble';
                typingIndicator.appendChild(bubble);
            }

            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Enviar mensaje al backend
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    model: 'openai',
                    intervention_mode: document.getElementById('intervention-mode').checked
                })
            })
            .then(response => response.json())
            .then(data => {
                // Eliminar indicador de escritura
                document.getElementById('typing-indicator')?.remove();

                // Agregar respuesta del asistente
                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'message assistant-message';
                assistantMsg.innerHTML = data.response || data.message || 'No se pudo obtener una respuesta.';
                messagesContainer.appendChild(assistantMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('typing-indicator')?.remove();

                // Mostrar error
                const errorMsg = document.createElement('div');
                errorMsg.className = 'system-message';
                errorMsg.innerHTML = `<p><i class="bi bi-exclamation-triangle-fill text-warning"></i> <strong>Error:</strong> ${error.message}</p>`;
                messagesContainer.appendChild(errorMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        // Manejar el botón de generar aplicación
        if (generateBtn) {
            generateBtn.addEventListener('click', function(event) {
                event.preventDefault();

                // Verificar que se haya ingresado una descripción
                const projectDescription = document.getElementById('project-description').value.trim();
                if (!projectDescription) {
                    alert('Por favor, describe tu aplicación');
                    return;
                }

                // Ocultar el formulario y mostrar el indicador de progreso
                constructorForm.style.display = 'none';
                generationProgress.style.display = 'block';

                // Generar ID único para el proyecto
                projectId = 'project_' + Date.now();

                // Recopilar datos del formulario
                const techData = document.getElementById('project-tech-data').value;
                const agentType = document.getElementById('agent-selector').value;
                const modelType = document.getElementById('model-selector').value;

                // Enviar solicitud al servidor
                fetch('/api/constructor/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_id: projectId,
                        description: projectDescription,
                        tech_data: techData,
                        agent_type: agentType,
                        model_type: modelType,
                        include_tests: document.getElementById('include-tests').checked,
                        include_docs: document.getElementById('include-docs').checked,
                        include_deployment: document.getElementById('include-deployment').checked,
                        include_ci_cd: document.getElementById('include-ci-cd').checked,
                        features: Array.from(document.querySelectorAll('#features-tags .feature-tag'))
                            .map(tag => tag.dataset.feature || tag.textContent.trim())
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Iniciar monitoreo de progreso
                        addConsoleMessage('Desarrollo iniciado: ' + (data.message || 'Procesando...'));
                        startProgressMonitoring(projectId);
                    } else {
                        // Mostrar error
                        addConsoleMessage('Error al iniciar desarrollo: ' + (data.error || 'No se pudo iniciar la generación'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addConsoleMessage('Error de conexión: ' + error.message, 'error');
                });
            });
        }

        // Manejar botones de pausar/reanudar desarrollo
        if (pauseDevelopmentBtn) {
            pauseDevelopmentBtn.addEventListener('click', function() {
                if (!projectId) {
                    addConsoleMessage('No hay un proyecto en desarrollo', 'warning');
                    return;
                }

                fetch(`/api/constructor/pause/${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addConsoleMessage('Desarrollo pausado - El asistente está listo para modificaciones', 'info');
                        pauseDevelopmentBtn.style.display = 'none';
                        resumeDevelopmentBtn.style.display = 'inline-block';

                        // Abrir el asistente
                        assistantPanel.style.display = 'flex';
                        chatInput.focus();
                    } else {
                        addConsoleMessage('Error al pausar desarrollo: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addConsoleMessage('Error de conexión: ' + error.message, 'error');
                });
            });
        }

        if (resumeDevelopmentBtn) {
            resumeDevelopmentBtn.addEventListener('click', function() {
                if (!projectId) {
                    addConsoleMessage('No hay un proyecto en desarrollo', 'warning');
                    return;
                }

                fetch(`/api/constructor/resume/${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addConsoleMessage('Desarrollo reanudado', 'success');
                        resumeDevelopmentBtn.style.display = 'none';
                        pauseDevelopmentBtn.style.display = 'inline-block';
                        startProgressMonitoring(projectId);
                    } else {
                        addConsoleMessage('Error al reanudar desarrollo: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addConsoleMessage('Error de conexión: ' + error.message, 'error');
                });
            });
        }

        // Función para monitorear el progreso
        function startProgressMonitoring(projectId) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const currentStage = document.getElementById('current-stage');

            // Función para verificar el estado del proyecto
            function checkStatus() {
                fetch(`/api/constructor/status/${projectId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Actualizar barra de progreso
                            progressBar.style.width = `${data.progress}%`;
                            progressBar.setAttribute('aria-valuenow', data.progress);
                            progressBar.textContent = `${data.progress}%`;

                            // Actualizar texto de progreso
                            if (progressText) {
                                progressText.textContent = `${data.progress}% completado`;
                            }

                            // Actualizar estado actual
                            currentStage.textContent = data.current_stage || 'Procesando...';

                            // Actualizar mensajes de consola si hay nuevos
                            if (data.console_message) {
                                const timestamp = new Date(data.console_message.time * 1000).toLocaleTimeString();
                                addConsoleMessage(`[${timestamp}] ${data.console_message.message}`);
                            }

                            // Actualizar información del framework si está disponible
                            if (data.tech_info && document.getElementById('framework-info')) {
                                document.getElementById('framework-info').classList.remove('d-none');
                                document.getElementById('framework-name').textContent = data.tech_info.name || 'Stack personalizado';
                                document.getElementById('backend-tech').textContent = data.tech_info.backend || '-';
                                document.getElementById('frontend-tech').textContent = data.tech_info.frontend || '-';
                                document.getElementById('database-tech').textContent = data.tech_info.database || '-';
                            }

                            // Verificar si está completado o hubo error
                            if (data.status === 'completed') {
                                document.getElementById('generation-progress').style.display = 'none';
                                document.getElementById('generation-result').style.display = 'block';

                                // Configurar botones de resultado
                                const viewBtn = document.getElementById('view-app-btn');
                                const downloadBtn = document.getElementById('download-app-btn');

                                if (viewBtn) {
                                    viewBtn.addEventListener('click', function() {
                                        window.open(`/api/constructor/preview/${projectId}`, '_blank');
                                    });
                                }

                                if (downloadBtn) {
                                    downloadBtn.addEventListener('click', function() {
                                        window.location.href = `/api/constructor/download/${projectId}`;
                                    });
                                }
                            } else if (data.status === 'failed') {
                                document.getElementById('result-message').className = 'alert alert-danger';
                                document.getElementById('result-message').innerHTML = 
                                    `<i class="bi bi-exclamation-circle me-2"></i> Error: ${data.error || 'Hubo un problema durante la generación'}`;
                                document.getElementById('generation-progress').style.display = 'none';
                                document.getElementById('generation-result').style.display = 'block';
                            } else {
                                // Continuar verificando el estado cada 2 segundos
                                setTimeout(checkStatus, 2000);
                            }
                        } else {
                            // Manejar error en la verificación del estado
                            addConsoleMessage('Error al verificar estado: ' + (data.error || 'Problema de conexión'), 'error');
                            // Intentar nuevamente después de un tiempo
                            setTimeout(checkStatus, 5000);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        addConsoleMessage('Error de conexión: ' + error.message, 'error');
                        // Intentar nuevamente después de un tiempo
                        setTimeout(checkStatus, 5000);
                    });
            }

            // Iniciar verificación de estado
            checkStatus();
        }

        // Función para agregar mensajes a la consola
        function addConsoleMessage(message, type = 'log') {
            if (!generationConsole) return;

            const messageElement = document.createElement('div');
            messageElement.className = `console-line ${type === 'error' ? 'error-line' : ''}`;
            messageElement.textContent = message;
            generationConsole.appendChild(messageElement);
            generationConsole.scrollTop = generationConsole.scrollHeight;
        }

        // Inicializar selector de tecnologías si existe el archivo
        if (typeof initTechSelector === 'function') {
            initTechSelector();
        }

        // Funciones para el asistente de programación

        /**
         * Aplica el código encontrado en un mensaje al proyecto
         * @param {string} messageId - ID del mensaje que contiene el código
         */
        function applyCodeToProject(messageId) {
            const message = document.getElementById(messageId);
            if (!message) return;

            // Buscar bloques de código en el mensaje
            const codeBlocks = message.querySelectorAll('pre code');
            if (codeBlocks.length === 0) {
                showNotification('No se encontró código para aplicar', 'error');
                return;
            }

            // Si hay más de un bloque, mostrar un diálogo de selección
            if (codeBlocks.length > 1) {
                showCodeSelectionDialog(messageId, codeBlocks);
                return;
            }

            // Si solo hay un bloque, extraer la información y mostrar el diálogo de aplicación
            const codeContent = codeBlocks[0].textContent;
            const language = codeBlocks[0].className.replace('language-', '');

            showFileSelectionDialog(codeContent, language);
        }

        /**
         * Muestra un diálogo para seleccionar qué bloque de código aplicar
         * @param {string} messageId - ID del mensaje
         * @param {NodeList} codeBlocks - Lista de bloques de código
         */
        function showCodeSelectionDialog(messageId, codeBlocks) {
            // Crear el modal de selección
            const modal = document.createElement('div');
            modal.className = 'code-selection-modal';
            modal.innerHTML = `
                <div class="code-selection-dialog">
                    <h3>Seleccionar código para aplicar</h3>
                    <div class="code-blocks-list">
                        ${Array.from(codeBlocks).map((block, index) => {
                            const language = block.className.replace('language-', '');
                            const preview = block.textContent.substring(0, 100) + (block.textContent.length > 100 ? '...' : '');
                            return `
                                <div class="code-block-option" data-index="${index}">
                                    <div class="code-block-header">
                                        <span class="code-language-badge">${language}</span>
                                        <button class="select-code-btn" onclick="selectCodeBlock('${messageId}', ${index})">Seleccionar</button>
                                    </div>
                                    <pre><code>${preview}</code></pre>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="dialog-actions">
                        <button onclick="closeCodeSelectionDialog()">Cancelar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        /**
         * Selecciona un bloque de código específico
         * @param {string} messageId - ID del mensaje
         * @param {number} blockIndex - Índice del bloque de código
         */
        function selectCodeBlock(messageId, blockIndex) {
            const message = document.getElementById(messageId);
            const codeBlocks = message.querySelectorAll('pre code');

            if (blockIndex >= 0 && blockIndex < codeBlocks.length) {
                const codeContent = codeBlocks[blockIndex].textContent;
                const language = codeBlocks[blockIndex].className.replace('language-', '');

                closeCodeSelectionDialog();
                showFileSelectionDialog(codeContent, language);
            }
        }

        /**
         * Cierra el diálogo de selección de código
         */
        function closeCodeSelectionDialog() {
            const modal = document.querySelector('.code-selection-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        /**
         * Muestra un diálogo para seleccionar o crear el archivo donde aplicar el código
         * @param {string} codeContent - Contenido del código
         * @param {string} language - Lenguaje del código
         */
        function showFileSelectionDialog(codeContent, language) {
            // Sugerir extensión de archivo basada en el lenguaje
            let fileExtension = '.txt';

            switch (language) {
                case 'javascript':
                case 'js':
                    fileExtension = '.js';
                    break;
                case 'typescript':
                case 'ts':
                    fileExtension = '.ts';
                    break;
                case 'python':
                case 'py':
                    fileExtension = '.py';
                    break;
                case 'html':
                    fileExtension = '.html';
                    break;
                case 'css':
                    fileExtension = '.css';
                    break;
                case 'json':
                    fileExtension = '.json';
                    break;
            }

            // Crear el modal de selección de archivo
            const modal = document.createElement('div');
            modal.className = 'file-selection-modal';
            modal.innerHTML = `
                <div class="file-selection-dialog">
                    <h3>Aplicar código a archivo</h3>

                    <div class="file-selection-tabs">
                        <button id="new-file-tab" class="file-tab active" onclick="switchFileTab('new')">Nuevo archivo</button>
                        <button id="existing-file-tab" class="file-tab" onclick="switchFileTab('existing')">Archivo existente</button>
                    </div>

                    <div id="new-file-panel" class="file-panel">
                        <div class="form-group">
                            <label for="new-file-name">Nombre de archivo:</label>
                            <input type="text" id="new-file-name" placeholder="nombre_archivo${fileExtension}" value="nuevo_archivo${fileExtension}">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="create-folder" onchange="toggleFolderInput()">
                                Crear en una nueva carpeta
                            </label>
                        </div>
                        <div class="form-group" id="folder-input" style="display: none;">
                            <label for="folder-name">Nombre de carpeta:</label>
                            <input type="text" id="folder-name" placeholder="nombre_carpeta">
                        </div>
                    </div>

                    <div id="existing-file-panel" class="file-panel" style="display: none;">
                        <div class="form-group">
                            <label for="existing-file-path">Ruta del archivo:</label>
                            <input type="text" id="existing-file-path" placeholder="ruta/al/archivo${fileExtension}">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="radio" name="replace-mode" value="replace" checked>
                                Reemplazar contenido completo
                            </label>
                            <label>
                                <input type="radio" name="replace-mode" value="append">
                                Añadir al final del archivo
                            </label>
                        </div>
                    </div>

                    <div class="code-preview">
                        <h4>Vista previa del código</h4>
                        <pre><code class="language-${language}">${codeContent}</code></pre>
                    </div>

                    <div class="dialog-actions">
                        <button onclick="applyCodeToFile('${encodeURIComponent(codeContent)}', '${language}')">Aplicar</button>
                        <button onclick="closeFileSelectionDialog()">Cancelar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Aplicar highlight.js a la vista previa
            if (window.hljs) {
                document.querySelectorAll('.code-preview pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
        }

        /**
         * Cambia entre las pestañas de nuevo archivo y archivo existente
         * @param {string} tab - Pestaña a mostrar ('new' o 'existing')
         */
        function switchFileTab(tab) {
            const newFileTab = document.getElementById('new-file-tab');
            const existingFileTab = document.getElementById('existing-file-tab');
            const newFilePanel = document.getElementById('new-file-panel');
            const existingFilePanel = document.getElementById('existing-file-panel');

            if (tab === 'new') {
                newFileTab.classList.add('active');
                existingFileTab.classList.remove('active');
                newFilePanel.style.display = 'block';
                existingFilePanel.style.display = 'none';
            } else {
                newFileTab.classList.remove('active');
                existingFileTab.classList.add('active');
                newFilePanel.style.display = 'none';
                existingFilePanel.style.display = 'block';
            }
        }

        /**
         * Muestra/oculta el campo de entrada de carpeta
         */
        function toggleFolderInput() {
            const folderInput = document.getElementById('folder-input');
            folderInput.style.display = document.getElementById('create-folder').checked ? 'block' : 'none';
        }

        /**
         * Cierra el diálogo de selección de archivo
         */
        function closeFileSelectionDialog() {
            const modal = document.querySelector('.file-selection-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        /**
         * Aplica el código al archivo especificado
         * @param {string} encodedCodeContent - Contenido del código codificado en URI
         * @param {string} language - Lenguaje del código
         */
        function applyCodeToFile(encodedCodeContent, language) {
            const codeContent = decodeURIComponent(encodedCodeContent);
            const newFileTab = document.getElementById('new-file-tab');

            // Determinar modo (nuevo archivo o existente)
            const isNewFile = newFileTab.classList.contains('active');

            let filePath = '';
            let mode = 'replace';

            if (isNewFile) {
                const fileName = document.getElementById('new-file-name').value.trim();
                if (!fileName) {
                    showNotification('Debes especificar un nombre de archivo', 'error');
                    return;
                }

                // Verificar si se creará en una carpeta
                if (document.getElementById('create-folder').checked) {
                    const folderName = document.getElementById('folder-name').value.trim();
                    if (!folderName) {
                        showNotification('Debes especificar un nombre de carpeta', 'error');
                        return;
                    }
                    filePath = `${folderName}/${fileName}`;
                } else {
                    filePath = fileName;
                }

                mode = 'create';
            } else {
                filePath = document.getElementById('existing-file-path').value.trim();
                if (!filePath) {
                    showNotification('Debes especificar la ruta del archivo', 'error');
                    return;
                }

                // Obtener modo de reemplazo
                const replaceMode = document.querySelector('input[name="replace-mode"]:checked').value;
                mode = replaceMode;
            }

            // Enviar solicitud al servidor
            fetch('/api/file/write', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    file_path: filePath,
                    content: codeContent,
                    mode: mode,
                    language: language
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Código aplicado a ${filePath}`, 'success');
                    closeFileSelectionDialog();

                    // Añadir mensaje del sistema informando de la acción
                    addSystemMessage(`Se ha ${mode === 'create' ? 'creado' : (mode === 'append' ? 'actualizado' : 'reemplazado')} el archivo <code>${filePath}</code> con el código aplicado.`);
                } else {
                    showNotification(`Error: ${data.error || 'No se pudo aplicar el código'}`, 'error');
                }
            })
            .catch(error => {
                showNotification(`Error: ${error.message}`, 'error');
            });
        }

        /**
         * Explora archivos relacionados con el código en un mensaje
         * @param {string} messageId - ID del mensaje que contiene el código
         */
        function exploreRelatedFiles(messageId) {
            const message = document.getElementById(messageId);
            if (!message) return;

            // Buscar bloques de código en el mensaje
            const codeBlocks = message.querySelectorAll('pre code');
            if (codeBlocks.length === 0) {
                showNotification('No se encontró código para analizar', 'error');
                return;
            }

            // Extraer código y lenguaje del primer bloque
            const codeContent = codeBlocks[0].textContent;
            const language = codeBlocks[0].className.replace('language-', '');

            // Mostrar indicador de carga
            addSystemMessage(`<i class="bi bi-search"></i> Buscando archivos relacionados con el código...`);

            // Enviar solicitud al servidor para buscar archivos relacionados
            fetch('/api/file/find_related', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: codeContent,
                    language: language
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // Mostrar archivos relacionados
                    let filesMessage = `<div class="related-files">
                        <h4><i class="bi bi-folder2"></i> Archivos relacionados encontrados:</h4>
                        <ul class="files-list">`;

                    data.files.forEach(file => {
                        filesMessage += `
                            <li class="file-item">
                                <span class="file-icon"><i class="bi bi-file-code"></i></span>
                                <span class="file-path">${file.path}</span>
                                <span class="file-actions">
                                    <button onclick="viewFileContent('${file.path}')" title="Ver contenido">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button onclick="openFileInEditor('${file.path}')" title="Abrir en editor">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                </span>
                            </li>`;
                    });

                    filesMessage += `</ul></div>`;
                    addSystemMessage(filesMessage);
                } else {
                    addSystemMessage(`<i class="bi bi-info-circle"></i> No se encontraron archivos relacionados con el código.`);
                }
            })
            .catch(error => {
                addSystemMessage(`<i class="bi bi-exclamation-triangle"></i> Error al buscar archivos relacionados: ${error.message}`);
            });
        }

        /**
         * Contextualiza el código con información del proyecto
         * @param {string} messageId - ID del mensaje que contiene el código
         */
        function contextualizeCode(messageId) {
            const message = document.getElementById(messageId);
            if (!message) return;

            // Buscar bloques de código en el mensaje
            const codeBlocks = message.querySelectorAll('pre code');
            if (codeBlocks.length === 0) {
                showNotification('No se encontró código para contextualizar', 'error');
                return;
            }

            // Extraer código y lenguaje del primer bloque
            const codeContent = codeBlocks[0].textContent;
            const language = codeBlocks[0].className.replace('language-', '');

            // Mostrar indicador de carga
            addSystemMessage(`<i class="bi bi-braces"></i> Contextualizando el código...`);

            // Enviar solicitud al servidor para contextualizar el código
            fetch('/api/code/contextualize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: codeContent,
                    language: language
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar contextualización
                    let contextMessage = `<div class="code-context">
                        <h4><i class="bi bi-braces"></i> Contextualización del código:</h4>
                        <div class="context-details">
                            ${data.explanation || 'No se pudo generar explicación'}
                        </div>`;

                    if (data.dependencies && data.dependencies.length > 0) {
                        contextMessage += `
                            <div class="context-section">
                                <h5>Dependencias detectadas:</h5>
                                <ul>
                                    ${data.dependencies.map(dep => `<li>${dep}</li>`).join('')}
                                </ul>
                            </div>`;
                    }

                    if (data.references && data.references.length > 0) {
                        contextMessage += `
                            <div class="context-section">
                                <h5>Referencias a otros archivos:</h5>
                                <ul>
                                    ${data.references.map(ref => `<li>${ref}</li>`).join('')}
                                </ul>
                            </div>`;
                    }

                    contextMessage += `</div>`;
                    addSystemMessage(contextMessage);
                } else {
                    addSystemMessage(`<i class="bi bi-exclamation-triangle"></i> Error al contextualizar el código: ${data.error || 'Error desconocido'}`);
                }
            })
            .catch(error => {
                addSystemMessage(`<i class="bi bi-exclamation-triangle"></i> Error al contextualizar el código: ${error.message}`);
            });
        }

        /**
         * Ver el contenido de un archivo
         * @param {string} filePath - Ruta del archivo
         */
        function viewFileContent(filePath) {
            // Mostrar indicador de carga
            addSystemMessage(`<i class="bi bi-hourglass-split"></i> Cargando contenido de ${filePath}...`);

            // Solicitar el contenido del archivo
            fetch('/api/file/read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    file_path: filePath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Determinar el lenguaje basado en la extensión
                    const extension = filePath.split('.').pop().toLowerCase();
                    let language = 'plaintext';

                    switch (extension) {
                        case 'js': language = 'javascript'; break;
                        case 'ts': language = 'typescript'; break;
                        case 'py': language = 'python'; break;
                        case 'html': language = 'html'; break;
                        case 'css': language = 'css'; break;
                        case 'json': language = 'json'; break;
                        // Añadir más mapeos según sea necesario
                    }

                    // Mostrar contenido del archivo
                    const fileContent = `<div class="file-content">
                        <div class="file-header">
                            <span><i class="bi bi-file-earmark-code"></i> ${filePath}</span>
                            <button onclick="openFileInEditor('${filePath}')" title="Abrir en editor">
                                <i class="bi bi-pencil-square"></i> Editar
                            </button>
                        </div>
                        <pre><code class="language-${language}">${data.content}</code></pre>
                    </div>`;

                    addSystemMessage(fileContent);

                    // Aplicar highlight.js
                    if (window.hljs) {
                        document.querySelectorAll('.file-content pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                } else {
                    addSystemMessage(`<i class="bi bi-exclamation-triangle"></i> Error al leer el archivo: ${data.error || 'Error desconocido'}`);
                }
            })
            .catch(error => {
                addSystemMessage(`<i class="bi bi-exclamation-triangle"></i> Error al leer el archivo: ${error.message}`);
            });
        }

        /**
         * Abre un archivo en el editor
         * @param {string} filePath - Ruta del archivo
         */
        function openFileInEditor(filePath) {
            // Redirigir a la página del editor con el archivo especificado
            window.open(`/editor?file=${encodeURIComponent(filePath)}`, '_blank');
        }

        /**
         * Muestra una notificación
         * @param {string} message - Mensaje de la notificación
         * @param {string} type - Tipo de notificación ('success', 'error', 'warning', 'info')
         */
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        /**
         * Agrega un mensaje del sistema al chat
         * @param {string} message - Mensaje a agregar
         */
        function addSystemMessage(message) {
            const systemMsg = document.createElement('div');
            systemMsg.className = 'message system-message';
            systemMsg.innerHTML = message;
            messagesContainer.appendChild(systemMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        // Inicializar el sistema de chat para el asistente de desarrollo
        if (sendButton && chatInput) {
            sendButton.addEventListener('click', sendChatMessage);

            // Enviar con Enter
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
        }

        // Función para enviar mensaje de chat
        function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Agregar mensaje del usuario
            const userMsg = document.createElement('div');
            userMsg.className = 'message user-message';
            userMsg.textContent = message;
            messagesContainer.appendChild(userMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Limpiar input
            chatInput.value = '';

            // Mostrar indicador de escritura
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.id = 'typing-indicator';

            for (let i = 0; i < 3; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'typing-bubble';
                typingIndicator.appendChild(bubble);
            }

            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Enviar mensaje al backend
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    model: 'openai',
                    intervention_mode: document.getElementById('intervention-mode').checked
                })
            })
            .then(response => response.json())
            .then(data => {
                // Eliminar indicador de escritura
                document.getElementById('typing-indicator')?.remove();

                // Agregar respuesta del asistente
                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'message assistant-message';
                assistantMsg.innerHTML = data.response || data.message || 'No se pudo obtener una respuesta.';
                messagesContainer.appendChild(assistantMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('typing-indicator')?.remove();

                // Mostrar error
                const errorMsg = document.createElement('div');
                errorMsg.className = 'system-message';
                errorMsg.innerHTML = `<p><i class="bi bi-exclamation-triangle-fill text-warning"></i> <strong>Error:</strong> ${error.message}</p>`;
                messagesContainer.appendChild(errorMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }
    });
</script>
{% endblock %}